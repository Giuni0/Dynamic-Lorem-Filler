\ProvidesPackage{filltext}[2025/10/22 v1.4 Dynamic Lorem filler]
\RequirePackage{luacode}
\RequirePackage{xparse}

% Define Lua function safely
\begin{luacode*}
function filltext_lua(mode, target, usertext)
  local lorem = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. " ..
                "Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. " ..
                "Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. "

  local function word_count(str)
    local c = 0
    for _ in string.gmatch(str, "%S+") do c = c + 1 end
    return c
  end

  if mode == "char" then
    local user_len = string.len(usertext)
    if user_len >= target then
      tex.sprint(usertext)
    else
      local needed = target - user_len
      local filled = usertext .. string.sub(lorem, 1, needed)
      tex.sprint(filled)
    end

  elseif mode == "word" then
    local user_words = word_count(usertext)
    if user_words >= target then
      tex.sprint(usertext)
    else
      local needed = target - user_words
      local words = {}
      for w in string.gmatch(lorem, "%S+") do
        table.insert(words, w)
        if #words >= needed then break end
      end
      local filled = usertext .. " " .. table.concat(words, " ")
      tex.sprint(filled)
    end
  else
    tex.sprint("Invalid mode: " .. mode)
  end
end
\end{luacode*}

% Wrapper LaTeX command
\NewDocumentCommand{\filltext}{O{char} m m}{%
  \directlua{
    filltext_lua("\unexpanded{#1}", tonumber("\unexpanded{#2}"), "\unexpanded{#3}")
  }%
}
